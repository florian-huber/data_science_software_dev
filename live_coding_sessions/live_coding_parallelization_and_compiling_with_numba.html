
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Speed it up! Part II &#8212; Data Science Software Development with Python</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'live_coding_sessions/live_coding_parallelization_and_compiling_with_numba';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../book/cover.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/cover_mini.png" class="logo__image only-light" alt="Data Science Software Development with Python - Home"/>
    <script>document.write(`<img src="../_static/cover_mini.png" class="logo__image only-dark" alt="Data Science Software Development with Python - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../book/cover.html">
                    Sofware Development für Data Scientists (mit Python)
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../book/01_introduction.html">1. Einführung</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/02_shell_scripting.html">2. Shell Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/03_git_github.html">3. Git &amp; GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/04_github.html">4. GitHub</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Clean Code</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../book/05_clean_code.html">5. Cleaner Code, Better Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/06_linting.html">6. Linting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/06_code_smells.html">7. Code Smells</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/06_python_software_project.html">8. Python Software Projekt</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Data Acquisition and First Exploration</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../book/06_testing.html">9. Code Testing with Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/07_continuous_integration.html">10. Introduction to Continuous Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/07_testing_2.html">11. Code Testing (2)</a></li>





</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">References</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../book/bibliography.html">Bibliography</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Source Code and Contributions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../book/github.html">Source Code on GitHub</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/florian-huber/data_science_software_dev/main?urlpath=tree/live_coding_sessions/live_coding_parallelization_and_compiling_with_numba.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/florian-huber/data_science_software_dev/blob/main/live_coding_sessions/live_coding_parallelization_and_compiling_with_numba.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/florian-huber/data_science_software_dev" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/florian-huber/data_science_software_dev/issues/new?title=Issue%20on%20page%20%2Flive_coding_sessions/live_coding_parallelization_and_compiling_with_numba.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/live_coding_sessions/live_coding_parallelization_and_compiling_with_numba.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Speed it up! Part II</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Speed it up! Part II</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#compile-it-with-numba">Compile it with Numba!</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compiling-modes">Compiling modes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reminder-last-weeks-options-were-python-vs-numpy-vs-dask">Reminder: last weeks options were Python vs. Numpy (vs. dask)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#numpy-version">Numpy version:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#numba-version">Numba version:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#wow-does-this-always-do-the-trick">Wow! Does this always do the trick?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-simulation-diffusion-process">Use case: simulation (diffusion process)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#check-runtime">Check runtime:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#numba-fy-your-code">Numba-fy your code!</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#numpy-fy-your-code">Numpy-fy your code!</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#try-to-parallelize">Try to parallelize</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization-with-vispy">Visualization with VisPy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#if-time-add-rigid-body-repulsion-kind-of">If time –&gt; add rigid-body repulsion (kind of)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-visualization-of-this-process">Create a visualization of this process</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="speed-it-up-part-ii">
<h1>Speed it up! Part II<a class="headerlink" href="#speed-it-up-part-ii" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numba</span>
<span class="c1">#import dask.array as da</span>
<span class="c1">#from joblib import Parallel, delayed</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section class="tex2jax_ignore mathjax_ignore" id="compile-it-with-numba">
<h1>Compile it with Numba!<a class="headerlink" href="#compile-it-with-numba" title="Link to this heading">#</a></h1>
<p>One of my favorite Python libraries is <code class="docutils literal notranslate"><span class="pre">Numba</span></code>. If <code class="docutils literal notranslate"><span class="pre">Numpy</span></code> or other greate libraries still don’t offer the right functions for your problem, than this is the perfect way to build very performant functions yourself (without any need to switch to C/C++ or other languages).</p>
<section id="compiling-modes">
<h2>Compiling modes<a class="headerlink" href="#compiling-modes" title="Link to this heading">#</a></h2>
<p>Numba offers several compilation modes. Typically we will work with</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nopython</span> <span class="pre">=</span> <span class="pre">True</span></code> which will raise an error if compilation in the fast “nopython mode” won’t work</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nogil</span> <span class="pre">=</span> <span class="pre">True</span></code> which can be used to avoid the restrictions of the GIL (global interpreter lock), but also requires a better understanding of what this means…</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">parallel</span> <span class="pre">=</span> <span class="pre">True</span></code> which enabels automatic parallelization (we will see more on this in a bit).</p></li>
</ul>
<p>See also <a class="reference external" href="https://numba.readthedocs.io/en/stable/user/jit.html">Numba documentation on compiling options</a>.</p>
<p>Or the <a class="reference external" href="https://numba.pydata.org/numba-doc/latest/user/5minguide.html">Numba 5 minutes guide</a>.</p>
</section>
<section id="reminder-last-weeks-options-were-python-vs-numpy-vs-dask">
<h2>Reminder: last weeks options were Python vs. Numpy (vs. dask)<a class="headerlink" href="#reminder-last-weeks-options-were-python-vs-numpy-vs-dask" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> sum(range(10**7))
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>122 ms ± 333 μs per loop (mean ± std. dev. of 7 runs, 10 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sum_range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the sum of the numbers in the range [0, N).&quot;&quot;&quot;</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">i</span>
    <span class="k">return</span> <span class="n">total</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> sum_range(10**7)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>346 ms ± 12.4 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
</section>
<section id="numpy-version">
<h2>Numpy version:<a class="headerlink" href="#numpy-version" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="o">%</span><span class="k">timeit</span> np.arange(10**7).sum()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>15.1 ms ± 89.8 μs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre></div>
</div>
</div>
</div>
</section>
<section id="numba-version">
<h2>Numba version:<a class="headerlink" href="#numba-version" title="Link to this heading">#</a></h2>
<p>In this example, numba has a couple of advantages.
First, it does not require to rethink the problem to convert it into a vectorized (<em>or numpy-fied</em>) version. This does not always work, but here it will.</p>
<p>Second, the numpy solution is not very elegant here and has a huge downside: it requires writing a full array of all numbers from <span class="math notranslate nohighlight">\(0\)</span> to <span class="math notranslate nohighlight">\(10^7\)</span> to memory, while the Python (and the numba) version only keep track of the one value stored in <code class="docutils literal notranslate"><span class="pre">total</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numba</span>

<span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sum_range_numba</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the sum of the numbers in the range [0, N).&quot;&quot;&quot;</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">i</span>
    <span class="k">return</span> <span class="n">total</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> sum_range_numba(10**7)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>135 ns ± 1.39 ns per loop (mean ± std. dev. of 7 runs, 10,000,000 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># second run:</span>
<span class="o">%</span><span class="k">timeit</span> sum_range_numba(10**7)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>136 ns ± 0.142 ns per loop (mean ± std. dev. of 7 runs, 10,000,000 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">sum_range_numba</span><span class="p">(</span><span class="mf">1e9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 40.3 ms, sys: 0 ns, total: 40.3 ms
Wall time: 40.1 ms
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>499999999500000000
</pre></div>
</div>
</div>
</div>
</section>
<section id="wow-does-this-always-do-the-trick">
<h2>Wow! Does this always do the trick?<a class="headerlink" href="#wow-does-this-always-do-the-trick" title="Link to this heading">#</a></h2>
<p>Sadly: no.</p>
<p>Numba compiles the code and this means we loose some aspects of what Python code can do.
With compiling, something that is not really important in Python suddently becomes very important: <strong>the data type</strong>.</p>
<p>Numba works best with Numpy data types and functions as well as basic Python data types and code.
In general Numba supports the following:</p>
<ul class="simple">
<li><p>Windows (32 and 64 bit), OSX and Linux (32 and 64 bit)</p></li>
<li><p>Architectures: x86, x86_64, ppc64le. Experimental on armv7l, armv8l (aarch64).</p></li>
<li><p>GPUs: Nvidia CUDA. Experimental on AMD ROC.</p></li>
<li><p>CPython (hence no Jython or others)</p></li>
<li><p>NumPy &gt;= 1.15</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
                   <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">],</span>
                  <span class="p">})</span>

<span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_max</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="n">get_max</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypingError</span><span class="g g-Whitespace">                               </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">line</span> <span class="mi">11</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="k">def</span> <span class="nf">get_max</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span>     <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="ne">---&gt; </span><span class="mi">11</span> <span class="n">get_max</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="nn">File ~/micromamba/envs/python_software_dev/lib/python3.12/site-packages/numba/core/dispatcher.py:423,</span> in <span class="ni">_DispatcherBase._compile_for_args</span><span class="nt">(self, *args, **kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">419</span>         <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="se">\n\n</span><span class="s2">This error may have been caused &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">420</span>                <span class="sa">f</span><span class="s2">&quot;by the following argument(s):</span><span class="se">\n</span><span class="si">{</span><span class="n">args_str</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">421</span>         <span class="n">e</span><span class="o">.</span><span class="n">patch_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">423</span>     <span class="n">error_rewrite</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;typing&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">424</span> <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">UnsupportedError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">425</span>     <span class="c1"># Something unsupported is present in the user code, add help info</span>
<span class="g g-Whitespace">    </span><span class="mi">426</span>     <span class="n">error_rewrite</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;unsupported_error&#39;</span><span class="p">)</span>

<span class="nn">File ~/micromamba/envs/python_software_dev/lib/python3.12/site-packages/numba/core/dispatcher.py:364,</span> in <span class="ni">_DispatcherBase._compile_for_args.&lt;locals&gt;.error_rewrite</span><span class="nt">(e, issue_type)</span>
<span class="g g-Whitespace">    </span><span class="mi">362</span>     <span class="k">raise</span> <span class="n">e</span>
<span class="g g-Whitespace">    </span><span class="mi">363</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">364</span>     <span class="k">raise</span> <span class="n">e</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

<span class="nn">TypingError: Failed</span> in <span class="ni">nopython mode pipeline </span><span class="nt">(step: nopython frontend)</span>
<span class="n">non</span><span class="o">-</span><span class="n">precise</span> <span class="nb">type</span> <span class="n">pyobject</span>
<span class="ne">During</span>: typing of argument at /tmp/ipykernel_3172/1526091316.py (7)

<span class="n">File</span> <span class="s2">&quot;../../../../../../tmp/ipykernel_3172/1526091316.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">7</span><span class="p">:</span>
<span class="o">&lt;</span><span class="n">source</span> <span class="n">missing</span><span class="p">,</span> <span class="n">REPL</span><span class="o">/</span><span class="n">exec</span> <span class="ow">in</span> <span class="n">use</span><span class="err">?</span><span class="o">&gt;</span> 

<span class="n">This</span> <span class="n">error</span> <span class="n">may</span> <span class="n">have</span> <span class="n">been</span> <span class="n">caused</span> <span class="n">by</span> <span class="n">the</span> <span class="n">following</span> <span class="n">argument</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="o">-</span> <span class="n">argument</span> <span class="mi">0</span><span class="p">:</span> <span class="n">Cannot</span> <span class="n">determine</span> <span class="n">Numba</span> <span class="nb">type</span> <span class="n">of</span> <span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="s1">&#39;&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">do_python_stuff</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">do_python_stuff</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[5, 6, 2]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">do_python_stuff</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;seven&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">do_python_stuff</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[5, 6, &#39;seven&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="use-case-simulation-diffusion-process">
<h2>Use case: simulation (diffusion process)<a class="headerlink" href="#use-case-simulation-diffusion-process" title="Link to this heading">#</a></h2>
<p>A diffusion process in form of Brownian motion can be simulated by small random changes to the position of all particles.
This requires updating the position of <em>every particle</em> a tiny bit for <em>many time steps</em> in a row. This makes it compute-intensive.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># Initialize particles</span>
<span class="n">n_particles</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">particles_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_particles</span><span class="p">)]</span>
<span class="n">particles_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_particles</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">particles_x</span><span class="p">,</span> <span class="n">particles_y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.collections.PathCollection at 0x1771de710c0&gt;
</pre></div>
</div>
<img alt="../_images/ce0194fc7375a41b9a6b246e26917618b0941667592ae40b3b52588db369dba1.png" src="../_images/ce0194fc7375a41b9a6b246e26917618b0941667592ae40b3b52588db369dba1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[-0.0966928558832502,
 -0.05266056667063153,
 0.014462821284259873,
 -0.0803017016266245,
 0.022035537129963083,
 0.015647713898649645,
 0.03557069739491065,
 -0.01905197521789405,
 0.15577332118291057,
 0.033316094105022086]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.collections.PathCollection at 0x1771df99930&gt;
</pre></div>
</div>
<img alt="../_images/8757f30905752baab5a86b771c111f93d794500521e4c02ddf1e886a90154e1e.png" src="../_images/8757f30905752baab5a86b771c111f93d794500521e4c02ddf1e886a90154e1e.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">diffusion_python</span><span class="p">(</span><span class="n">particles_x</span><span class="p">,</span> <span class="n">particles_y</span><span class="p">,</span> <span class="n">n_timesteps</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_timesteps</span><span class="p">):</span>
        <span class="n">particles_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">particles_x</span><span class="p">]</span>
        <span class="n">particles_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">particles_y</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">particles_x</span><span class="p">,</span> <span class="n">particles_y</span>

<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">diffusion_python</span><span class="p">(</span><span class="n">particles_x</span><span class="p">,</span> <span class="n">particles_y</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="check-runtime">
<h2>Check runtime:<a class="headerlink" href="#check-runtime" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="c1"># Initialize particles</span>
<span class="n">n_particles</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">particles_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_particles</span><span class="p">)]</span>
<span class="n">particles_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_particles</span><span class="p">)]</span>

<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">diffusion_python</span><span class="p">(</span><span class="n">particles_x</span><span class="p">,</span> <span class="n">particles_y</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: total: 391 ms
Wall time: 2.44 s
</pre></div>
</div>
</div>
</div>
</section>
<section id="numba-fy-your-code">
<h2>Numba-fy your code!<a class="headerlink" href="#numba-fy-your-code" title="Link to this heading">#</a></h2>
<p>Now, please try to convert the <code class="docutils literal notranslate"><span class="pre">diffusion_python</span></code> function to a just-in-time compiled <code class="docutils literal notranslate"><span class="pre">diffusion_numba</span></code> function.</p>
<p>Try by simply using the <code class="docutils literal notranslate"><span class="pre">&#64;numba.jit(nopython=True)</span></code> decorator.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">diffusion_numba</span><span class="p">(</span><span class="n">particles_x</span><span class="p">,</span> <span class="n">particles_y</span><span class="p">,</span> <span class="n">n_timesteps</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_timesteps</span><span class="p">):</span>
        <span class="n">particles_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">particles_x</span><span class="p">]</span>
        <span class="n">particles_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">particles_y</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">particles_x</span><span class="p">,</span> <span class="n">particles_y</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="c1"># Initialize particles</span>
<span class="n">particles_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_particles</span><span class="p">)]</span>
<span class="n">particles_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_particles</span><span class="p">)]</span>

<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">diffusion_numba</span><span class="p">(</span><span class="n">particles_x</span><span class="p">,</span> <span class="n">particles_y</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: total: 46.9 ms
Wall time: 141 ms
</pre></div>
</div>
</div>
</div>
</section>
<section id="numpy-fy-your-code">
<h2>Numpy-fy your code!<a class="headerlink" href="#numpy-fy-your-code" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">diffusion_numpy</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="n">n_timesteps</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_timesteps</span><span class="p">):</span>
        <span class="n">particles</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">particles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">particles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">particles</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="c1"># Initialize particles</span>
<span class="n">n_particles</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">particles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_particles</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

<span class="n">particles</span> <span class="o">=</span> <span class="n">diffusion_numpy</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: total: 31.2 ms
Wall time: 97.4 ms
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">particles</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(10000, 2)
</pre></div>
</div>
</div>
</div>
</section>
<section id="try-to-parallelize">
<h2>Try to parallelize<a class="headerlink" href="#try-to-parallelize" title="Link to this heading">#</a></h2>
<p>“Embarassingly parallel” –&gt; <code class="docutils literal notranslate"><span class="pre">range</span></code> –&gt; <code class="docutils literal notranslate"><span class="pre">prange</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">diffusion_numba_parallel</span><span class="p">(</span><span class="n">n_particles</span><span class="p">,</span> <span class="n">n_timesteps</span><span class="p">):</span>
    <span class="c1"># Initialize particles</span>
    <span class="n">particles</span> <span class="o">=</span> <span class="p">[[</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_particles</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">particle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">particles</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">numba</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="n">n_timesteps</span><span class="p">):</span>
            <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">particle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">particle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">particles</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Will kill kernel!</span>
<span class="o">%%time</span>
<span class="n">particles</span> <span class="o">=</span> <span class="n">diffusion_numba_parallel</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numba</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">prange</span>

<span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">diffusion_numba_parallel</span><span class="p">(</span><span class="n">n_particles</span><span class="p">,</span> <span class="n">n_timesteps</span><span class="p">):</span>
    <span class="c1"># Initialize particles using a NumPy array</span>
    <span class="n">particles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">n_particles</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">n_particles</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_timesteps</span><span class="p">):</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
            <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span>
            <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy</span>

    <span class="k">return</span> <span class="n">particles</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">particles</span> <span class="o">=</span> <span class="n">diffusion_numba_parallel</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: total: 15.6 ms
Wall time: 12.1 ms
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualization-with-vispy">
<h2>Visualization with VisPy<a class="headerlink" href="#visualization-with-vispy" title="Link to this heading">#</a></h2>
<p>Install VisPy with <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">vispy</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!pip install vispy</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">gui</span> qt
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">diffusion</span><span class="p">(</span><span class="n">particles_x</span><span class="p">,</span> <span class="n">particles_y</span><span class="p">,</span> <span class="n">n_timesteps</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_timesteps</span><span class="p">):</span>
        <span class="n">particles_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">particles_x</span><span class="p">]</span>
        <span class="n">particles_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">particles_y</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">particles_x</span><span class="p">,</span> <span class="n">particles_y</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">vispy</span> <span class="kn">import</span> <span class="n">scene</span>
<span class="kn">from</span> <span class="nn">vispy.app</span> <span class="kn">import</span> <span class="n">Timer</span>

<span class="c1"># Define our points/spheres</span>
<span class="n">n_points</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">sizes</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_points</span><span class="p">))</span>
<span class="n">face_colors</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_points</span><span class="p">)]</span>

<span class="c1"># Create a canvas with interactive controls</span>
<span class="n">canvas</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">SceneCanvas</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="s1">&#39;interactive&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">view</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">central_widget</span><span class="o">.</span><span class="n">add_view</span><span class="p">()</span>

<span class="c1"># Set up camera</span>
<span class="n">view</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="s1">&#39;turntable&#39;</span>
<span class="n">view</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">fov</span> <span class="o">=</span> <span class="mi">45</span>
<span class="n">view</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="mi">50</span>

<span class="c1"># Generate initial random coordinates for points</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_points</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_points</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Create a scatter plot</span>
<span class="n">scatter</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">visuals</span><span class="o">.</span><span class="n">Markers</span><span class="p">()</span>
<span class="n">scatter</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">face_color</span><span class="o">=</span><span class="n">face_colors</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sizes</span><span class="p">)</span>
<span class="n">view</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span>

<span class="c1"># Diffusion loop</span>
<span class="k">def</span> <span class="nf">diffusion_step</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
  
    <span class="c1"># Update points positions</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">diffusion</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">scatter</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">face_color</span><span class="o">=</span><span class="n">face_colors</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sizes</span><span class="p">)</span>

<span class="c1"># Create a timer to update the plot</span>
<span class="n">timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">connect</span><span class="o">=</span><span class="n">diffusion_step</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: Traceback (most recent call last):
  File &quot;C:\Users\flori\anaconda3\envs\python_software_dev\lib\runpy.py&quot;, line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File &quot;C:\Users\flori\anaconda3\envs\python_software_dev\lib\runpy.py&quot;, line 86, in _run_code
    exec(code, run_globals)
  File &quot;C:\Users\flori\anaconda3\envs\python_software_dev\lib\site-packages\ipykernel_launcher.py&quot;, line 17, in &lt;module&gt;
    app.launch_new_instance()
  File &quot;C:\Users\flori\anaconda3\envs\python_software_dev\lib\site-packages\traitlets\config\application.py&quot;, line 992, in launch_instance
    app.start()
  File &quot;C:\Users\flori\anaconda3\envs\python_software_dev\lib\site-packages\ipykernel\kernelapp.py&quot;, line 736, in start
    self.io_loop.start()
  File &quot;C:\Users\flori\anaconda3\envs\python_software_dev\lib\site-packages\tornado\platform\asyncio.py&quot;, line 195, in start
    self.asyncio_loop.run_forever()
  File &quot;C:\Users\flori\anaconda3\envs\python_software_dev\lib\asyncio\base_events.py&quot;, line 603, in run_forever
    self._run_once()
  File &quot;C:\Users\flori\anaconda3\envs\python_software_dev\lib\asyncio\base_events.py&quot;, line 1909, in _run_once
    handle._run()
  File &quot;C:\Users\flori\anaconda3\envs\python_software_dev\lib\asyncio\events.py&quot;, line 80, in _run
    self._context.run(self._callback, *self._args)
  File &quot;C:\Users\flori\anaconda3\envs\python_software_dev\lib\site-packages\tornado\ioloop.py&quot;, line 738, in _run_callback
    ret = callback()
  File &quot;C:\Users\flori\anaconda3\envs\python_software_dev\lib\site-packages\ipykernel\kernelbase.py&quot;, line 461, in advance_eventloop
    eventloop(self)
  File &quot;C:\Users\flori\anaconda3\envs\python_software_dev\lib\site-packages\ipykernel\eventloops.py&quot;, line 128, in loop_qt
    el.exec() if hasattr(el, &#39;exec&#39;) else el.exec_()
  File &quot;C:\Users\flori\anaconda3\envs\python_software_dev\lib\site-packages\vispy\app\backends\_qt.py&quot;, line 968, in _vispy_timeout
    self._vispy_timer._timeout()
  File &quot;C:\Users\flori\anaconda3\envs\python_software_dev\lib\site-packages\vispy\app\timer.py&quot;, line 160, in _timeout
    self.events.timeout(
  File &quot;C:\Users\flori\anaconda3\envs\python_software_dev\lib\site-packages\vispy\util\event.py&quot;, line 453, in __call__
    self._invoke_callback(cb, event)
  File &quot;C:\Users\flori\anaconda3\envs\python_software_dev\lib\site-packages\vispy\util\event.py&quot;, line 471, in _invoke_callback
    _handle_exception(self.ignore_callback_errors,
  &lt;&lt; caught exception here: &gt;&gt;
  File &quot;C:\Users\flori\anaconda3\envs\python_software_dev\lib\site-packages\vispy\util\event.py&quot;, line 469, in _invoke_callback
    cb(event)
  File &quot;C:\Users\flori\AppData\Local\Temp\ipykernel_35104\980765414.py&quot;, line 34, in diffusion_step
    x, y = diffusion(x, y, 10)
  File &quot;C:\Users\flori\anaconda3\envs\python_software_dev\lib\site-packages\numba\core\dispatcher.py&quot;, line 468, in _compile_for_args
    error_rewrite(e, &#39;typing&#39;)
  File &quot;C:\Users\flori\anaconda3\envs\python_software_dev\lib\site-packages\numba\core\dispatcher.py&quot;, line 409, in error_rewrite
    raise e.with_traceback(None)
numba.core.errors.TypingError: Failed in nopython mode pipeline (step: nopython frontend)
<span class=" -Color -Color-Bold">Cannot unify array(float64, 1d, C) and list(float64)&lt;iv=None&gt; for &#39;particles_y.2&#39;, defined at C:\Users\flori\AppData\Local\Temp\ipykernel_35104\1346740720.py (7)</span>

<span class=" -Color -Color-Bold">File &quot;..\..\..\..\..\Users\flori\AppData\Local\Temp\ipykernel_35104\1346740720.py&quot;, line 7:</span>
<span class=" -Color -Color-Bold">&lt;source missing, REPL/exec in use?&gt;</span>

<span class=" -Color -Color-Bold">During: typing of assignment at C:\Users\flori\AppData\Local\Temp\ipykernel_35104\1346740720.py (7)</span>

<span class=" -Color -Color-Bold">File &quot;..\..\..\..\..\Users\flori\AppData\Local\Temp\ipykernel_35104\1346740720.py&quot;, line 7:</span>
<span class=" -Color -Color-Bold">&lt;source missing, REPL/exec in use?&gt;</span>
ERROR: Invoking &lt;function diffusion_step at 0x000001772DBDB760&gt; for Event
</pre></div>
</div>
</div>
</div>
</section>
<section id="if-time-add-rigid-body-repulsion-kind-of">
<h2>If time –&gt; add rigid-body repulsion (kind of)<a class="headerlink" href="#if-time-add-rigid-body-repulsion-kind-of" title="Link to this heading">#</a></h2>
<p>So far, the particles can take any position and can overlap in any way.
To make the particle motion look at least a bit more realistic, we can introduce some sort of repulsion between particles.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numba</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute distance between p1 and p2.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add_noise</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add normal distributed noise to x and y.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">y</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">apply_repulsion</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="c1"># Add repulsion if to elements are closer than 2x their radius</span>
    <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">d</span><span class="p">:</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">d</span> <span class="o">-</span> <span class="n">dist</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">force</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">force</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">p1</span>

<span class="k">def</span> <span class="nf">diffusion_step</span><span class="p">(</span><span class="n">particles</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">add_noise</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">particles</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">repulsion_step</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">max_motion</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">apply_repulsion</span><span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">d</span><span class="p">)</span>
            <span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">apply_repulsion</span><span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">particles</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">radius</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">particles</span> <span class="o">=</span> <span class="p">[(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">radius</span><span class="p">,</span> <span class="n">radius</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">radius</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">particles</span> <span class="o">=</span> <span class="n">diffusion_step</span><span class="p">(</span><span class="n">particles</span><span class="p">)</span>
    <span class="n">particles</span> <span class="o">=</span> <span class="n">repulsion_step</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: total: 297 ms
Wall time: 927 ms
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-visualization-of-this-process">
<h2>Create a visualization of this process<a class="headerlink" href="#create-a-visualization-of-this-process" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">vispy</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">scene</span>
<span class="kn">from</span> <span class="nn">vispy.app</span> <span class="kn">import</span> <span class="n">Timer</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">500</span>  <span class="c1"># Number of particles</span>
<span class="n">d</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Size of each particle</span>
<span class="n">radius</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Radius of the starting sphere</span>

<span class="c1"># Create a canvas with interactive controls</span>
<span class="n">canvas</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">SceneCanvas</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="s1">&#39;interactive&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">view</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">central_widget</span><span class="o">.</span><span class="n">add_view</span><span class="p">()</span>

<span class="c1"># Set up camera</span>
<span class="n">view</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="s1">&#39;turntable&#39;</span>
<span class="n">view</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">fov</span> <span class="o">=</span> <span class="mi">45</span>
<span class="n">view</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="mi">50</span>

<span class="c1"># Initialize particles</span>
<span class="n">particles</span> <span class="o">=</span> <span class="p">[(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">radius</span><span class="p">,</span> <span class="n">radius</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">radius</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
<span class="n">sizes</span> <span class="o">=</span> <span class="mi">25</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="c1"># Create a scatter plot</span>
<span class="n">scatter</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">visuals</span><span class="o">.</span><span class="n">Markers</span><span class="p">()</span>
<span class="n">scatter</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">particles</span><span class="p">),</span> <span class="n">edge_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sizes</span><span class="p">)</span> <span class="c1">#, face_color=face_colors, size=sizes) #(1, 1, 1, 1), size=5)</span>
<span class="n">view</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span>

<span class="c1"># Diffusion loop</span>
<span class="k">def</span> <span class="nf">particle_motion</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">particles</span>
    
    <span class="c1"># Apply Brownian motion</span>
    <span class="n">particles</span> <span class="o">=</span> <span class="n">diffusion_step</span><span class="p">(</span><span class="n">particles</span><span class="p">)</span>

    <span class="c1"># Apply repulsion</span>
    <span class="n">particles</span> <span class="o">=</span> <span class="n">repulsion_step</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">scatter</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">particles</span><span class="p">),</span> <span class="n">edge_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sizes</span><span class="p">)</span>

<span class="c1"># Create a timer to update the plot</span>
<span class="n">timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">connect</span><span class="o">=</span><span class="n">particle_motion</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ERROR: Invoking &lt;function diffusion_step at 0x0000017731825FC0&gt; repeat 2048
ERROR: Invoking &lt;function diffusion_step at 0x000001772DBDB760&gt; repeat 2048
ERROR: Invoking &lt;function diffusion_step at 0x0000017731825FC0&gt; repeat 4096
ERROR: Invoking &lt;function diffusion_step at 0x000001772DBDB760&gt; repeat 4096
ERROR: Invoking &lt;function diffusion_step at 0x0000017731825FC0&gt; repeat 8192
ERROR: Invoking &lt;function diffusion_step at 0x000001772DBDB760&gt; repeat 8192
ERROR: Invoking &lt;function diffusion_step at 0x0000017731825FC0&gt; repeat 16384
ERROR: Invoking &lt;function diffusion_step at 0x000001772DBDB760&gt; repeat 16384
ERROR: Invoking &lt;function diffusion_step at 0x0000017731825FC0&gt; repeat 32768
ERROR: Invoking &lt;function diffusion_step at 0x000001772DBDB760&gt; repeat 32768
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">vispy</span> <span class="kn">import</span> <span class="n">scene</span>
<span class="kn">from</span> <span class="nn">vispy.app</span> <span class="kn">import</span> <span class="n">Timer</span>

<span class="c1"># Define our points/spheres</span>
<span class="n">n_points</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">sizes</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_points</span><span class="p">))</span>
<span class="n">face_colors</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_points</span><span class="p">)]</span>

<span class="c1"># Create a canvas with interactive controls</span>
<span class="n">canvas</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">SceneCanvas</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="s1">&#39;interactive&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">view</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">central_widget</span><span class="o">.</span><span class="n">add_view</span><span class="p">()</span>

<span class="c1"># Set up camera</span>
<span class="n">view</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="s1">&#39;turntable&#39;</span>
<span class="n">view</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">fov</span> <span class="o">=</span> <span class="mi">45</span>
<span class="n">view</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="mi">50</span>

<span class="c1"># Generate initial random coordinates for points</span>
<span class="n">particles</span> <span class="o">=</span> <span class="p">[(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">radius</span><span class="p">,</span> <span class="n">radius</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">radius</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_points</span><span class="p">)]</span>

<span class="c1"># Create a scatter plot</span>
<span class="n">scatter</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">visuals</span><span class="o">.</span><span class="n">Markers</span><span class="p">()</span>
<span class="n">scatter</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">particles</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">face_color</span><span class="o">=</span><span class="n">face_colors</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sizes</span><span class="p">)</span>
<span class="n">view</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span>

<span class="c1"># Diffusion loop</span>
<span class="k">def</span> <span class="nf">diffusion_step</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">particles</span>
    
    <span class="n">particles</span> <span class="o">=</span> <span class="n">diffusion_step</span><span class="p">(</span><span class="n">particles</span><span class="p">)</span>
    <span class="n">particles</span> <span class="o">=</span> <span class="n">repulsion_step</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">scatter</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">particles</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">face_color</span><span class="o">=</span><span class="n">face_colors</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sizes</span><span class="p">)</span>

<span class="c1"># Create a timer to update the plot</span>
<span class="n">timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">connect</span><span class="o">=</span><span class="n">diffusion_step</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AssertionError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">65</span><span class="p">],</span> <span class="n">line</span> <span class="mi">23</span>
<span class="g g-Whitespace">     </span><span class="mi">21</span> <span class="c1"># Create a scatter plot</span>
<span class="g g-Whitespace">     </span><span class="mi">22</span> <span class="n">scatter</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">visuals</span><span class="o">.</span><span class="n">Markers</span><span class="p">()</span>
<span class="ne">---&gt; </span><span class="mi">23</span> <span class="n">scatter</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">particles</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">face_color</span><span class="o">=</span><span class="n">face_colors</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sizes</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">24</span> <span class="n">view</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span> <span class="c1"># Diffusion loop</span>

<span class="nn">File ~\anaconda3\envs\python_software_dev\lib\site-packages\vispy\visuals\markers.py:633,</span> in <span class="ni">MarkersVisual.set_data</span><span class="nt">(self, pos, size, edge_width, edge_width_rel, edge_color, face_color, symbol)</span>
<span class="g g-Whitespace">    </span><span class="mi">629</span>     <span class="n">face_color</span> <span class="o">=</span> <span class="n">face_color</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">631</span> <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">632</span>     <span class="k">assert</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span>
<span class="nn">--&gt; 633             pos.ndim == 2 and pos.shape[1]</span> in <span class="nt">(2, 3))</span>
<span class="g g-Whitespace">    </span><span class="mi">635</span>     <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">636</span>     <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;a_position&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
<span class="g g-Whitespace">    </span><span class="mi">637</span>                               <span class="p">(</span><span class="s1">&#39;a_fg_color&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="g g-Whitespace">    </span><span class="mi">638</span>                               <span class="p">(</span><span class="s1">&#39;a_bg_color&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="g g-Whitespace">    </span><span class="mi">639</span>                               <span class="p">(</span><span class="s1">&#39;a_size&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
<span class="g g-Whitespace">    </span><span class="mi">640</span>                               <span class="p">(</span><span class="s1">&#39;a_edgewidth&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
<span class="g g-Whitespace">    </span><span class="mi">641</span>                               <span class="p">(</span><span class="s1">&#39;a_symbol&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)])</span>

<span class="ne">AssertionError</span>: 
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ERROR: Invoking &lt;function diffusion_step at 0x0000017731825FC0&gt; repeat 512
ERROR: Invoking &lt;function diffusion_step at 0x000001772DBDB760&gt; repeat 512
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./live_coding_sessions"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Speed it up! Part II</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#compile-it-with-numba">Compile it with Numba!</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compiling-modes">Compiling modes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reminder-last-weeks-options-were-python-vs-numpy-vs-dask">Reminder: last weeks options were Python vs. Numpy (vs. dask)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#numpy-version">Numpy version:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#numba-version">Numba version:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#wow-does-this-always-do-the-trick">Wow! Does this always do the trick?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-simulation-diffusion-process">Use case: simulation (diffusion process)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#check-runtime">Check runtime:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#numba-fy-your-code">Numba-fy your code!</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#numpy-fy-your-code">Numpy-fy your code!</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#try-to-parallelize">Try to parallelize</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization-with-vispy">Visualization with VisPy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#if-time-add-rigid-body-repulsion-kind-of">If time –&gt; add rigid-body repulsion (kind of)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-visualization-of-this-process">Create a visualization of this process</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Florian Huber
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>